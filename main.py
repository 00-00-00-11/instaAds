from instaclient import InstaClient
from instaclient.errors import *
from database import DataBase
import json
import random, string
import wget
import requests



client = InstaClient(driver_path='./driver/chromedriver')

# Login
try:
    client.login(username='zxikh__', password='Siktir4961')
except VerificationCodeNecessary:
    code = input('Enter the 2FA security code generated by your Authenticator App or sent to you by SMS')
    client.input_verification_code(code)
except SuspisciousLoginAttemptError as error:
    if error.mode == SuspisciousLoginAttemptError.EMAIL:
        code = input('Enter the security code that was sent to you via email: ')
    else:
        code = input('Enter the security code that was sent to you via SMS: ')
    client.input_security_code(code)

# Menu
print(f"{DataBase.sentCount()}/{DataBase.Count()} Users\n")
print("1- Send")
print("2- Fetch")
print("3- Test")
choice = int(input('Choose by number: '))

if choice == 1:
	for user in DataBase.GetFromDB():

		if not int(user[3]):
			try:
				DataBase.SendUpdate(user[1], 2)
				client.send_dm(user[1], 'Suck My Dixk and Give me your pussy')
        
				print(f"Sending to {user[1]} "+"\033[32m"+"Success"+"\033[0m")
			except:
				DataBase.SendUpdate(user[1], 1)
				print(f"Sending to {user[1]} "+"\033[31m"+"Failed"+"\033[0m")
elif choice == 2:
	x = client.get_followers(user=input("Username: "), count=None)
	print(x)
	aList = []
	for i in x:
		for j in i:
			
			try:

				rndname = 'profile'.join(random.choice(string.ascii_lowercase) for _ in range(6))
				img_url = j.profile_pic_url
				file_name = f'{rndname}.jpeg'
				r = requests.get(img_url, allow_redirects=True)
				open(file_name, 'wb').write(r.content)

				aList.append({'username': j.username ,'firstname_lastname':j.name,'profile':file_name})
				print(j.profile_pic_url)

			except:
				pass
	jsonStr = json.dumps(aList)
	print(jsonStr)
	f = open("data.json", "w")
	f.write(jsonStr)
	f.close()
